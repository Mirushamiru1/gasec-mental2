
import React, {useEffect, useState} from 'react'
import { db, auth, signInAnonymously } from '../firebase.js'
import { collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from 'firebase/firestore'
export default function Chat(){ const [room,setRoom]=useState('general'),[msgs,setMsgs]=useState([]),[val,setVal]=useState('')
  useEffect(()=>{ (async ()=>{ try{ await signInAnonymously(auth) }catch{} })(); const q = query(collection(db,'rooms',room,'messages'),orderBy('createdAt')); const unsub = onSnapshot(q,snap=>{ const arr=[]; snap.forEach(d=>arr.push({...d.data(), id:d.id})); setMsgs(arr) }); return ()=>unsub() },[room])
  async function send(){ if(!val) return; const anon = sessionStorage.getItem('anonId')||('Anon'+Math.floor(Math.random()*900+100)); sessionStorage.setItem('anonId',anon); await addDoc(collection(db,'rooms',room,'messages'),{text:val,anonymousId:anon,createdAt:serverTimestamp()}); setVal('') }
  return (<div className="container"><div className="card"><h4>Anonymous Chat</h4><select value={room} onChange={e=>setRoom(e.target.value)} className="form-control"><option value="general">General</option><option value="exam-stress">Exam Stress</option><option value="friendships">Friendships</option></select><div style={{height:320,overflow:'auto',background:'#f3f4f6',padding:8,borderRadius:8,marginTop:8}}>{msgs.map((m,i)=>(<div key={i} style={{marginBottom:10}}><div style={{fontSize:12,color:'#6b7280'}}>{m.anonymousId} â€¢ {m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</div><div>{m.text}</div></div>))}</div><div style={{display:'flex',gap:8,marginTop:8}}><input className="form-control" value={val} onChange={e=>setVal(e.target.value)}/><button className="button" onClick={send}>Send</button></div></div></div>) }
